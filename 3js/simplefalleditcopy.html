<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
		<title>threejs testbed</title>
		<style>
			body { margin: 0; }
			canvas { display: block; }
		</style>
	<script type="text/javascript" src="/js/Three.js"></script>
	<script type="text/javascript" src="/js/physi.js"></script>
	<script src="/js/GLTFLoader.js"></script>
	
	
</head>

<body>

<script type="text/javascript">
	
	// 'use strict';

	window.addEventListener('resize', function()
	{
		renderer.setSize(window.innerWidth, window.innerHeight);
		camera.aspect = window.innerWidth/window.innerHeight;
		camera.updateProjectionMatrix();
	});
	
	Physijs.scripts.worker = '/js/physijs_worker.js';
	Physijs.scripts.ammo = '/js/ammo.js';
	
	var initScene, render, renderer, scene, camera, box, vehicle, input, isTrolleyLoaded;
	
	initScene = function() {
		renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setSize( window.innerWidth, window.innerHeight );
		document.body.appendChild( renderer.domElement );
		
		//INIT_ENV
		scene = new Physijs.Scene;
		scene.setGravity(new THREE.Vector3( 0, -30, 0 ));

		//INIT_PLATFORM
		var pf = 4.2;  //platform friction
		var pr = 0;  //platform restitution
		var platform;
  		var platformDiameter = 170;
  		var platformRadiusTop = platformDiameter * 0.5;  
  		var platformRadiusBottom = platformDiameter * 0.5 + 0.2;
  		var platformHeight = 1;
  		var platformSegments = 85;
  
  		var platformGeometry = new THREE.CylinderGeometry( 
   			 	platformRadiusTop, 
    			platformRadiusBottom, 
    			platformHeight, 
    			platformSegments 
  			);

		var physiPlatformMaterial = Physijs.createMaterial(new THREE.MeshLambertMaterial({color: 0xff0000}), pf, pr);
  		var physiPlatform = new Physijs.CylinderMesh(platformGeometry, physiPlatformMaterial, 0 );
  		physiPlatform.name = "physicalPlatform";
  		physiPlatform.position.set(0, -5, 0);
  		physiPlatform.visible = true;
		scene.add( physiPlatform );


		//INIT_CAMERA
		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			0.1,
			1000
		);
		camera.position.set( 10, 10, 10 );
		camera.lookAt( scene.position );
		scene.add( camera );
		
		//INIT_BOX
		
		box = new Physijs.BoxMesh(
			new THREE.CubeGeometry( 1, 0.1, 1.5 ),
			new THREE.MeshBasicMaterial({ color: 0x888888, transparent: true })
			
		);
		box.rotation.y = Math.PI/2
		scene.add( box );


		//INIT_TROLLEY
		var loader = new THREE.GLTFLoader();
		var trolley;
		isTrolleyLoaded = false;
		loader.load('/models/trolleythree.glb', function(gltf)
		{
			trolley = gltf.scene;
			isTrolleyLoaded = true;
			trolley.rotation.y= Math.PI/2;
			box.add (trolley);
			box.position.y = 0.5;
			//function(xhr){}, function(error){});

			vehicle = new Physijs.Vehicle(box, new Physijs.VehicleTuning
			(
				10.88,
				1.83,
				0.28,
				500,
				10.5,
				6000
			));
			// console.log(vehicle);
			// vehicle.isObject3D = true;
			scene.add( vehicle );

			var wheel_material =  Physijs.createMaterial
			(
				new THREE.MeshLambertMaterial({ color: 0x444444 }),
				.8, // high friction
				.5 // medium restitution
			);
			var wheel_geometry = new THREE.CylinderGeometry( 0.5, 0.5, 0.1, 16 );
			for ( var i = 0; i < 4; i++ ) 
			{
				vehicle.addWheel(
					wheel_geometry,
					wheel_material,
					new THREE.Vector3(
						i % 2 === 0 ? -1.6 : 1.6,	//left or right side
						0,
						i < 2 ? 3.3 : -3.2			//back or front side
						), //connection point?
					new THREE.Vector3( 0, -1, 0 ), //wheel direction?
					new THREE.Vector3( 0, 0, 1 ), //wheel axle?
					0.1, //suspension
					0.7, //radius
					// i < 2 ? true : false //front wheel
				);
			}

			input = {
				power: false,
				direction: 0,
				steering: 0
			};
			document.addEventListener('keydown', function( ev ) {
			switch ( ev.keyCode ) {
					case 37: // left
					input.direction = 1;
					break;

					case 38: // forward
					input.power = true;
					break;

					case 39: // right
					input.direction = -1;
					break;

					case 40: // back
					input.power = false;
					break;
			}
			});
			document.addEventListener('keyup', function( ev ) {
					switch ( ev.keyCode ) {
					case 37: // left
					input.direction = null;
					break;

					case 38: // forward
					input.power = false;
					break;

					case 39: // right
					input.direction = null;
					break;

					case 40: // back
					input.power = false;
					break;
				}
			});
		});

		//INIT_TROLLEY_MV_LOGIC
		scene.addEventListener('update', function () 
		{
			if ( input && vehicle ) {
				if ( input.direction !== null ) {
					input.steering += input.direction / 50;
					if ( input.steering < -.6 ) input.steering = -.6;
					if ( input.steering > .6 ) input.steering = .6;
				}
				vehicle.setSteering( input.steering, 0 );
				vehicle.setSteering( input.steering, 1 );

				if ( input.power === true ) {
					vehicle.applyEngineForce( 1 );
				} else if ( input.power === false ) {
					vehicle.setBrake( 20, 2 );
					vehicle.setBrake( 20, 3 );
				} else {
					vehicle.applyEngineForce( 0 );
				}
			}
		}
		);
			
		//INIT_LIGHTS
		var directionalLight = new THREE.DirectionalLight( 0xffffff, 5 );
		scene.add( directionalLight );

		var light = new THREE.PointLight( 0xffffff, 10, 10 );
		light.position.set( -5, 5, 5 );
		scene.add( light );

		var ambientLight = new THREE.AmbientLight(0xffffff, 1);
		scene.add(ambientLight);

		requestAnimationFrame( render );
	};
	
	render = function() {
		scene.simulate(); // run physics
		// if (isTrolleyLoaded) vehicle.applyEngineForce( 300 );
		renderer.render( scene, camera); // render the scene
		requestAnimationFrame( render );
		'update';
	};
	
	window.onload = initScene();
	
	</script>
</body>
</html>
