<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="/js/Three.js"></script>
	<script type="text/javascript" src="/js/physi.js"></script>
	<script src="/js/GLTFLoader.js"></script>
	<meta charset="utf-8">
	<title>threejs testbed</title>
	<style>
		body { margin: 0; }
		canvas { display: block; }
	</style>
	
	
	
</head>

<body>

<script type="text/javascript">
	
	'use strict';
	
	Physijs.scripts.worker = '/js/physijs_worker.js';
	Physijs.scripts.ammo = '/js/ammo.js';
	
	var initScene, scene, camera, car={};
	
	var renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setSize( window.innerWidth, window.innerHeight );
		document.body.appendChild( renderer.domElement );

	initScene = function() 
	{
		scene = new Physijs.Scene;
		
		//PLATFORM INIT
		var pf = 4.2;  //platform friction
		var pr = 0;  //platform restitution

		var platform;
  		var platformDiameter = 170;
  		var platformRadiusTop = platformDiameter * 0.5;  
  		var platformRadiusBottom = platformDiameter * 0.5 + 0.2;
  		var platformHeight = 1;
  		var platformSegments = 85;
  
  		var platformGeometry = new THREE.CylinderGeometry( 
   			 	platformRadiusTop, 
    			platformRadiusBottom, 
    			platformHeight, 
    			platformSegments 
  			);

		var physiPlatformMaterial = Physijs.createMaterial(
    	new THREE.MeshLambertMaterial(), pf, pr  
 		 );
  		var physiPlatform = new Physijs.CylinderMesh(platformGeometry, physiPlatformMaterial, 0 );
  		physiPlatform.name = "physicalPlatform";
  		physiPlatform.position.set(0, -0.5, 0);
  		physiPlatform.visible = false;
  		scene.add( physiPlatform );


		//CAMERA INIT
		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			0.1,
			1000
		);
		camera.position.set( 10, 10, 10 );
		camera.lookAt( scene.position );
		scene.add( camera );
		
		//CAR INIT
		var bfpx = 0;
		var bfpy = 1.5;
		var bfpz = 0;

		var car_material = Physijs.createMaterial(
			new THREE.MeshLambertMaterial({ color: 0xff6666 }),
			.8, // high friction
			.1 // low restitution
		);
  		car.frame = new Physijs.BoxMesh(
			  	new THREE.CubeGeometry( 4, 1, 2 ),
				car_material,
				1000
				);
  		//car.frame.name = "frame";
  		//car.frame.componentOf = "car";
  		car.frame.position.set( bfpx ,bfpy,bfpz);
		car.frame.castShadow = true;
		 
		var carInteriorGeometry = new THREE.BoxGeometry( 2, 1, 2);
  		var carInteriorMaterial = Physijs.createMaterial( new THREE.MeshStandardMaterial({ color: 0x777777 }), 50, 50 );
 		car.interior = new Physijs.BoxMesh(carInteriorGeometry, carInteriorMaterial, 50 );
  		//car.interior.name = "interior";
  		car.interior.visible = false;  //(if visible, edges stick out from rounded frame)
 		//car.interior.componentOf = "car"; 
  		car.interior.position.set( bfpx, bfpy, bfpz );
  		car.frame.add(car.interior);

		
		//trolley
		var loader = new THREE.GLTFLoader();
			
		loader.load('/models/trolleythree.glb', function(gltf)
		{
			car.body = gltf.scene;
			//car.body.name = "body";
			//car.body.componentOf = "car";
			car.body.castShadow = true;
			
			car.frame.add(car.body);
		},
			function(xhr){}, function(error){}
		);
		scene.add( car.frame );

		var wheel_material = Physijs.createMaterial(
			new THREE.MeshLambertMaterial({ color: 0x444444 }),
			.5, // friction
			0.9 //  restitution
			);
		var wheel_geometry = new THREE.CylinderGeometry( 0.5, 0.5, 0.25, 16 );

		//INIT FRONT LEFT
		car.wheel_fl = new Physijs.CylinderMesh(
			wheel_geometry,
			wheel_material,
			500
		);
		var valx = 1.3;	//maybe change these to const?
		var valy = 0.8;
		var valz = 1.6;
		car.wheel_fl.rotation.x = Math.PI / 2;
		car.wheel_fl.position.set( -valx, valy, valz);
		car.wheel_fl.receiveShadow = car.wheel_fl.castShadow = true;
		scene.add( car.wheel_fl );
		car.wheel_fl_constraint = new Physijs.DOFConstraint(
			car.wheel_fl, car.frame, new THREE.Vector3( -valx, valy, valz )
		);
		scene.addConstraint( car.wheel_fl_constraint );
		car.wheel_fl_constraint.setAngularLowerLimit({ x: 0, y: 0, z: 0.5 });
		car.wheel_fl_constraint.setAngularUpperLimit({ x: 0, y: 0, z: 0 });

		var wheelConstructor = function ()
		
		car.wheel_fr = new Physijs.CylinderMesh(
			wheel_geometry,
			wheel_material,
			500
		);
		car.wheel_fr.rotation.x = Math.PI / 2;
		car.wheel_fr.position.set( -valx, valy, -valz );
		car.wheel_fr.receiveShadow = car.wheel_fr.castShadow = true;
		scene.add( car.wheel_fr );
		car.wheel_fr_constraint = new Physijs.DOFConstraint(
			car.wheel_fr, car.frame, new THREE.Vector3( -valx, valy, -valz )
		);
		scene.addConstraint( car.wheel_fr_constraint );
		car.wheel_fr_constraint.setAngularLowerLimit({ x: 0, y: 0, z: 0.5 });
		car.wheel_fr_constraint.setAngularUpperLimit({ x: 0, y: 0, z: 0 });
		
		car.wheel_bl = new Physijs.CylinderMesh(
			wheel_geometry,
			wheel_material,
			500
		);
		car.wheel_bl.rotation.x = Math.PI / 2;
		car.wheel_bl.position.set( valx, valy, valz );
		car.wheel_bl.receiveShadow = car.wheel_bl.castShadow = true;
		scene.add( car.wheel_bl );
		car.wheel_bl_constraint = new Physijs.DOFConstraint(
			car.wheel_bl, car.frame, new THREE.Vector3( valx, valy, valz )
		);
		scene.addConstraint( car.wheel_bl_constraint );
		car.wheel_bl_constraint.setAngularLowerLimit({ x: 0, y: 0, z: 0 });
		car.wheel_bl_constraint.setAngularUpperLimit({ x: 0, y: 0, z: 0 });
		
		car.wheel_br = new Physijs.CylinderMesh(
			wheel_geometry,
			wheel_material,
			500
		);
		car.wheel_br.rotation.x = Math.PI / 2;
		car.wheel_br.position.set( valx, valy, -valz );
		car.wheel_br.receiveShadow = car.wheel_br.castShadow = true;
		scene.add( car.wheel_br );
		car.wheel_br_constraint = new Physijs.DOFConstraint(
			car.wheel_br, car.frame, new THREE.Vector3( valx, valy, -valz )
		);
		scene.addConstraint( car.wheel_br_constraint );
		car.wheel_br_constraint.setAngularLowerLimit({ x: 0, y: 0, z: 0 });
		car.wheel_br_constraint.setAngularUpperLimit({ x: 0, y: 0, z: 0 });
		
		document.addEventListener(
			'keydown',
			function( ev ) {
				switch( ev.keyCode ) {
					case 37:
						// Left
						car.wheel_fl_constraint.configureAngularMotor( 1, -Math.PI / 4, Math.PI / 4, 1, 200 );
						car.wheel_fl_constraint.enableAngularMotor( 1 );
						car.wheel_fr_constraint.configureAngularMotor( 1, -Math.PI / 4, Math.PI / 4, 1, 200 );
						car.wheel_fr_constraint.enableAngularMotor( 1 );
						break;
					
					case 39:
						// Right
						car.wheel_fl_constraint.configureAngularMotor( 1, -Math.PI / 4, Math.PI / 4, -1, 200 );
						car.wheel_fl_constraint.enableAngularMotor( 1 );
						car.wheel_fr_constraint.configureAngularMotor( 1, -Math.PI / 4, Math.PI / 4, -1, 200 );
						car.wheel_fr_constraint.enableAngularMotor( 1 );
						break;
					
					case 38:
						// Up
						car.wheel_bl_constraint.configureAngularMotor( 2, 1, 0, 5, 2000 );
						car.wheel_bl_constraint.enableAngularMotor( 2 );
						car.wheel_br_constraint.configureAngularMotor( 2, 1, 0, 5, 2000 );
						car.wheel_br_constraint.enableAngularMotor( 2 );
						break;
					
					case 40:
						// Down
						car.wheel_bl_constraint.configureAngularMotor( 2, 1, 0, -5, 2000 );
						car.wheel_br_constraint.enableAngularMotor( 2 );
						car.wheel_br_constraint.configureAngularMotor( 2, 1, 0, -5, 2000 );
						car.wheel_bl_constraint.enableAngularMotor( 2 );
						break;
				}
			}
		);
		document.addEventListener(
			'keyup',
			function( ev ) {
				switch( ev.keyCode ) {
					case 37:
						// Left
						car.wheel_fl_constraint.configureAngularMotor( 1, 0, 0, 1, 200 );
						car.wheel_fl_constraint.disableAngularMotor( 1 );
						car.wheel_fr_constraint.configureAngularMotor( 1, 0, 0, 1, 200 );
						car.wheel_fr_constraint.disableAngularMotor( 1 );
						break;
					
					case 39:
						// Right
						car.wheel_fl_constraint.configureAngularMotor( 1, 0, 0, 1, 200 );
						car.wheel_fl_constraint.disableAngularMotor( 1 );
						car.wheel_fr_constraint.configureAngularMotor( 1, 0, 0, 1, 200 );
						car.wheel_fr_constraint.disableAngularMotor( 1 );
						break;
					
					case 38:
						// Up
						car.wheel_bl_constraint.disableAngularMotor( 2 );
						car.wheel_br_constraint.disableAngularMotor( 2 );
						break;
					
					case 40:
						// Down
						car.wheel_bl_constraint.disableAngularMotor( 2 );
						car.wheel_br_constraint.disableAngularMotor( 2 );
						break;
				}
			}
		);
			
			   var directionalLight = new THREE.DirectionalLight( 0xffffff, 5 );
			scene.add( directionalLight );

			var light = new THREE.PointLight( 0xffffff, 10, 10 );
			light.position.set( -5, 5, 5 );
			scene.add( light );

			var light = new THREE.PointLight( 0xffffff, 10, 10 );
			light.position.set( 5, -5, 5 );
			scene.add( light );


			var ambientLight = new THREE.AmbientLight(0xffffff, 1);
			scene.add(ambientLight);
			

			requestAnimationFrame( render );
		scene.simulate();
	};

	window.onload = initScene();
	function render() {
		scene.simulate(); // run physics
		renderer.render( scene, camera); // render the scene
		requestAnimationFrame( render );
	};
	render();
	
	
	</script>
</body>
</html>
