<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="/js/Three.js"></script>
	<script type="text/javascript" src="/js/physi.js"></script>
	<script src="/js/GLTFLoader.js"></script>
	<script src="/js/FirstPersonControls.js"></script>
	
	
</head>

<body>
	<div id="viewport"></div>

<script type="text/javascript">
	
	'use strict';
	
	Physijs.scripts.worker = '/js/physijs_worker.js';
	Physijs.scripts.ammo = '/js/ammo.js';
	
	var initScene, scene, camera;
	var controls, isTrolleyLoaded;
	var renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setSize( window.innerWidth, window.innerHeight );
		document.getElementById( 'viewport' ).appendChild( renderer.domElement );

	initScene = function() {
		
		
		scene = new Physijs.Scene;
		
		var pf = 4.2;  //platform friction
		var pr = 0;  //platform restitution

		var platform;
  		var platformDiameter = 170;
  		var platformRadiusTop = platformDiameter * 0.5;  
  		var platformRadiusBottom = platformDiameter * 0.5 + 0.2;
  		var platformHeight = 1;
  		var platformSegments = 85;
  
  		var platformGeometry = new THREE.CylinderGeometry( 
   			 	platformRadiusTop, 
    			platformRadiusBottom, 
    			platformHeight, 
    			platformSegments 
  			);

		var physiPlatformMaterial = Physijs.createMaterial(
    	new THREE.MeshLambertMaterial(), pf, pr  
 		 );
  		var physiPlatform = new Physijs.CylinderMesh(platformGeometry, physiPlatformMaterial, 0 );
  		physiPlatform.name = "physicalPlatform";
  		physiPlatform.position.set(0, -0.5, 0);
  		physiPlatform.visible = false;
  		scene.add( physiPlatform );

		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			0.1,
			1000
		);
		camera.position.set( 10, 10, 10 );
		camera.lookAt( scene.position );
		scene.add( camera );
		
		// Box
		
		//box = new Physijs.BoxMesh(
		//	new THREE.CubeGeometry( 1, 1, 1 ),
		//	new THREE.MeshBasicMaterial({ color: 0x888888 })
			
		//);
		//scene.add( box );
		var bfpx = 0;
		var bfpy = 5;
		var bfpz = 0;
		var bus = new Physijs.BoxMesh(
			new THREE.CubeGeometry( 0.01, 0.01, 0.01 ),
			new THREE.MeshBasicMaterial({ color: 0x888888 })
		);
  		bus.frame = new Physijs.BoxMesh(
			  	new THREE.CubeGeometry( 0.01, 0.01, 0.01 ),
				new THREE.MeshBasicMaterial({ color: 0x888888 })
				);
  		bus.frame.name = "frame";
  		bus.frame.componentOf = "bus";
  		bus.frame.position.set( 0,5,0);
		bus.frame.castShadow = true;
		  
		var busInteriorGeometry = new THREE.BoxGeometry( 33, 7, 11 );
  		var busInteriorMesh = new THREE.MeshStandardMaterial({ color: 0x777777 });
  		var busInteriorMaterial = Physijs.createMaterial( busInteriorMesh, 50, 50 );
 		bus.interior = new Physijs.BoxMesh(busInteriorGeometry, busInteriorMaterial, 5000 );
  		bus.interior.name = "interior";
  		bus.interior.visible = false;  //(if visible, edges stick out from rounded frame)
 		bus.interior.componentOf = "bus"; 
  		bus.interior.position.set( bfpx, bfpy, bfpz );
  		bus.frame.add(bus.interior);

		
		//trolley
		var loader = new THREE.GLTFLoader();
			
		isTrolleyLoaded = false;
			loader.load('/models/trolleythree.glb', function(gltf)
			{
				bus.body = gltf.scene;
				bus.body.name = "body";
				bus.body.componentOf = "bus";
				bus.body.castShadow = true;
				bus.body.position.set ( 0, 0, 0 );
      			bus.frame.add(bus.body);
				isTrolleyLoaded = true;

				controls = new THREE.FirstPersonControls(bus.body, renderer.domElement);
				controls.activeLook = false;
				scene.add( bus.frame );

   			},
			   function(xhr){}, function(error){}
			   );

			
			   var directionalLight = new THREE.DirectionalLight( 0xffffff, 5 );
			scene.add( directionalLight );

			var light = new THREE.PointLight( 0xffffff, 10, 10 );
			light.position.set( -5, 5, 5 );
			scene.add( light );

			var light = new THREE.PointLight( 0xffffff, 10, 10 );
			light.position.set( 5, -5, 5 );
			scene.add( light );


			var ambientLight = new THREE.AmbientLight(0xffffff, 1);
			scene.add(ambientLight);
			

		
	};

	window.onload = initScene();

	var clock = new THREE.Clock();
	
	function render() {
		scene.simulate(); // run physics
		var delta = clock.getDelta();
		if (isTrolleyLoaded) controls.update(delta);
		renderer.render( scene, camera); // render the scene
		requestAnimationFrame( render );
	};
	render();
	
	
	</script>
</body>
</html>
